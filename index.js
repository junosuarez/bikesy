var request = require('request');

/*
// test data for development; ignore
var data = '?([[["start northwest", "1st Street", 0, 0, 0, [-122.39909362792969, 37.790996551513672]], ["left", "Market Street", 0, 0, 0, [-122.39918518066406, 37.791069030761719]], ["left", "New Montgomery Street", 0, 0, 0, [-122.4019775390625, 37.788856506347656]], ["right", "Market Street", 0, 0, 0, [-122.40199279785156, 37.788734436035156]], ["sharp right", "nameless", 0, 0, 0, [-122.40212249755859, 37.788623809814453]], ["left", "Market Street", 0, 0, 0, [-122.40213775634766, 37.788726806640625]], ["right", "Grant Avenue", 0, 0, 0, [-122.40462493896484, 37.786762237548828]], ["left", "Post Street", 0, 0, 0, [-122.40522003173828, 37.788692474365234]], ["left", "nameless", 0, 0, 0, [-122.40676879882812, 37.788497924804688]], ["left", "nameless", 0, 0, 0, [-122.40711975097656, 37.788211822509766]]], ["u`teFhaajVMPxLlPVBTXS@fKpN[n@eJfAf@rHZ^XV@Ln@G", "B?????@?@@???B"], [[0, 5.090794563293457], [5.6952972412109375, 5.0808525085449219], [11.390594482421875, 5.0836153030395508], [11.390594482421875, 5.0836153030395508], [20.932723999023438, 5.0951981544494629], [20.932723999023438, 5.0951981544494629], [29.401252746582031, 5.0945181846618652], [37.869777679443359, 5.1249079704284668], [46.338306427001953, 5.271904468536377], [54.806831359863281, 5.3984313011169434], [54.806831359863281, 5.3984313011169434], [64.311492919921875, 5.4049463272094727], [73.816154479980469, 5.558535099029541], [83.320816040039062, 5.7657880783081055], [92.825469970703125, 5.9837870597839355], [102.33013153076172, 6.117337703704834], [111.83479309082031, 6.3355917930603027], [121.33945465087891, 6.5285472869873047], [130.8441162109375, 6.7212791442871094], [130.8441162109375, 6.7212791442871094], [140.75166320800781, 6.9430599212646484], [150.65922546386719, 7.1525249481201172], [160.56678771972656, 7.3502364158630371], [170.47434997558594, 7.5752978324890137], [180.38189697265625, 7.7956509590148926], [190.28945922851562, 7.9945430755615234], [200.197021484375, 8.1527805328369141], [210.10458374023438, 8.3443746566772461], [220.01214599609375, 8.5513715744018555], [229.91969299316406, 8.7717456817626953], [239.82725524902344, 9.005366325378418], [249.73481750488281, 9.0577182769775391], [259.64236450195312, 9.1836910247802734], [269.5499267578125, 9.3808526992797852], [279.45748901367188, 9.4150514602661133], [289.36505126953125, 9.5016994476318359], [289.36505126953125, 9.5016994476318359], [298.8076171875, 9.7032957077026367], [308.25021362304688, 9.6961259841918945], [317.69277954101562, 9.8126306533813477], [327.13534545898438, 10.022661209106445], [336.57794189453125, 10.195803642272949], [346.0205078125, 10.285033226013184], [346.0205078125, 10.285033226013184], [352.4930419921875, 10.308257102966309], [358.965576171875, 10.401517868041992], [358.965576171875, 10.401517868041992], [365.77328491210938, 10.419399261474609], [372.58096313476562, 10.44151782989502], [372.58096313476562, 10.44151782989502], [380.96673583984375, 10.618865013122559], [389.35250854492188, 10.776061058044434], [389.35250854492188, 10.776061058044434], [395.10781860351562, 10.812529563903809], [400.86312866210938, 10.828330993652344], [400.86312866210938, 10.828330993652344], [410.53036308288574, 10.871820449829102], [420.19759750366211, 10.951825141906738], [429.86483192443848, 11.123003959655762], [439.53206634521484, 11.185976028442383], [449.19929885864258, 11.238445281982422], [458.86653518676758, 11.465444564819336], [468.53376770019531, 11.655270576477051], [478.20100402832031, 11.814753532409668], [487.86823272705078, 11.986377716064453], [497.53546905517578, 12.115141868591309], [497.53546905517578, 12.115141868591309], [507.44747161865234, 12.191903114318848], [517.35947418212891, 12.321714401245117], [527.27146911621094, 12.445140838623047], [537.1834716796875, 12.756958961486816], [547.09547424316406, 12.899529457092285], [547.09547424316406, 12.899529457092285], [554.78968811035156, 12.940570831298828], [562.48391723632812, 13.074662208557129], [562.48391723632812, 13.074662208557129], [572.31622314453125, 13.213672637939453], [582.14852905273438, 13.208253860473633], [591.98085021972656, 13.24895191192627], [601.81315612792969, 13.33223819732666], [611.64546203613281, 13.383220672607422], [621.47776794433594, 13.43757438659668], [631.31008911132812, 13.51103401184082], [641.14239501953125, 13.507919311523438], [650.97470092773438, 13.74571704864502], [660.8070068359375, 14.050485610961914], [670.63931274414062, 14.180371284484863], [680.47164916992188, 14.247829437255859], [690.303955078125, 14.122160911560059], [700.13626098632812, 14.142421722412109], [709.96856689453125, 14.143918037414551], [709.96856689453125, 14.143918037414551], [718.83737754821777, 14.246791839599609], [727.7061882019043, 14.342877388000488], [736.57499885559082, 14.6595458984375], [746.21219253540039, 14.871933937072754], [755.84938812255859, 15.028750419616699], [765.4865837097168, 15.199889183044434], [775.123779296875, 15.2781982421875], [784.76097106933594, 15.3739013671875], [794.39816284179688, 15.544597625732422], [803.73048400878906, 15.723336219787598], [813.06280517578125, 15.753419876098633], [822.39512634277344, 15.802582740783691], [831.72744750976562, 15.852910995483398], [831.72744750976562, 15.852910995483398], [840.71990966796875, 15.925028800964355], [849.71238708496094, 16.03773307800293], [858.70484924316406, 16.226062774658203], [867.69732666015625, 16.516523361206055], [876.68978881835938, 16.826622009277344], [885.68226623535156, 16.986061096191406], [885.68226623535156, 16.986061096191406], [894.32601928710938, 17.170339584350586], [902.96977233886719, 17.390497207641602], [911.61354064941406, 17.607759475708008], [920.25729370117188, 17.787311553955078], [928.90104675292969, 18.040992736816406], [937.5447998046875, 18.345361709594727], [937.5447998046875, 18.345361709594727], [947.06918334960938, 18.618497848510742], [956.59355163574219, 18.982206344604492], [966.117919921875, 19.296245574951172], [975.64227294921875, 19.606473922729492], [975.64227294921875, 19.606473922729492], [985.39898681640625, 19.851186752319336], [995.15570068359375, 20.165328979492188], [1004.9123840332031, 20.596565246582031], [1004.9123840332031, 20.596565246582031], [1013.5189819335938, 20.955686569213867], [1022.1255798339844, 21.327905654907227], [1030.732177734375, 21.618400573730469], [1030.732177734375, 21.618400573730469], [1038.3816223144531, 21.810497283935547], [1046.0310974121094, 22.000234603881836], [1053.6805419921875, 22.193042755126953], [1061.3299865722656, 22.395757675170898], [1061.3299865722656, 22.395757675170898], [1067.5101928710938, 22.530595779418945], [1067.5101928710938, 22.530595779418945], [1075.6739501953125, 22.56719970703125], [1075.6739501953125, 22.56719970703125], [1082.8078398704529, 22.509199142456055], [1089.9417295455933, 22.520662307739258], [1097.0756206512451, 22.599649429321289], [1105.8627052307129, 22.91325569152832], [1114.6497917175293, 23.306537628173828], [1121.4890899658203, 23.563129425048828], [1121.4890899658203, 23.563129425048828], [1130.202564239502, 23.758033752441406], [1138.9160385131836, 23.803684234619141], [1147.629508972168, 23.817644119262695]], {"route_desc_time": 0.0034990310668945312, "route_find_time": 0.0038568973541259766, "endpoint_find_time": 0.00094509124755859375}, {"total_elev": 0, "total_dist": 26.358399790548397}])';
request = function(x, cb) {
  cb(null, {
    body: data
  });
}
*/


var defaultOptions = {
    hillLevel: 'low',
    safetyLevel: 'high'
  };
function bikesy(origin, destination, options, callback) {
  if (!callback) {
    callback = options
    options = defaultOptions
  }
  if (!options) {
    options = defaultOptions
  }
  if (!options.safetyLevel) options.safetyLevel = defaultOptions.safetyLevel
  if (!options.hillLevel) options.hillLevel = defaultOptions.hillLevel

  var url = 'http://api.bikesy.com?'
    + 'lat1=' + origin.lat
    + '&lng1=' + origin.lon
    + '&lat2=' + destination.lat
    + '&lng2=' + destination.lon
    + '&hill=' + options.hillLevel
    + '&safety=' + options.safetyLevel

  request(url, function (err, result) {
    if (err) return cb(new Error('an api error occurred'))
    console.log(result);

    callback(null,
      Directions(
        JSON.parse(
          stripJSONP(result.body))))

  });
}

function stripJSONP(result) {
  // unpack silly jsonp wrapper
  return result.substring(2, result.length - 1);
}

function Directions(apiResponse) {
  return {
    steps: apiResponse[0].map(Step),
    totalElevation: apiResponse[4].total_elev,
    totalDistance: apiResponse[4].total_dist
  };
}

function Step(apiStep) {
  return {
    direction: apiStep[0],
    location: apiStep[1],
    lat: apiStep[5][1],
    lon: apiStep[5][0]
  }
}

module.exports = bikesy;
